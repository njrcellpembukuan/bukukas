<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NJR Cell â€“ Buku Kas</title>
  <meta name="description" content="Aplikasi buku kas sederhana berbasis web untuk NJR Cell. Simpan data di browser, ekspor/impor JSON/CSV, grafik arus kas, dan filter laporan." />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.18.0/tabler-icons.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    html, body { height: 100%; }
    .card { @apply bg-white rounded-2xl shadow-sm border border-slate-200; }
    .chip { @apply text-xs px-2 py-0.5 rounded-full border; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 border bg-white hover:bg-slate-50 active:scale-[.99]; }
    .btn-primary { @apply bg-slate-900 text-white hover:bg-black border-slate-900; }
    .btn-danger { @apply bg-red-600 text-white border-red-600 hover:bg-red-700; }
    .input { @apply w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400; }
    .select { @apply w-full rounded-xl border border-slate-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-slate-400; }
    .label { @apply block text-sm font-medium text-slate-700 mb-1; }
    .kbd { @apply px-1.5 py-0.5 rounded border bg-slate-50 text-slate-700 text-[11px]; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
  <div class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 space-y-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="space-y-1">
        <h1 class="text-2xl md:text-3xl font-bold">ðŸ“’ Buku Kas â€“ <span class="text-slate-700">NJR Cell</span></h1>
        <p class="text-slate-600">Catat pemasukan & pengeluaran harian. Data tersimpan <span class="font-semibold">lokal di browser</span>. Ekspor untuk backup.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="exportJsonBtn" class="btn" title="Ekspor JSON"><i class="ti ti-download"></i> Ekspor JSON</button>
        <button id="exportCsvBtn" class="btn" title="Ekspor CSV"><i class="ti ti-table"></i> Ekspor CSV</button>
        <label class="btn cursor-pointer" title="Impor JSON">
          <i class="ti ti-upload"></i> Impor JSON
          <input id="importJsonInput" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="clearAllBtn" class="btn btn-danger" title="Hapus semua data"><i class="ti ti-trash"></i> Hapus Semua</button>
      </div>
    </header>

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card p-4">
        <div class="text-sm text-slate-500">Saldo</div>
        <div id="saldo" class="text-2xl font-bold mt-1">Rp 0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-slate-500">Total Masuk</div>
        <div id="totalMasuk" class="text-2xl font-bold mt-1">Rp 0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-slate-500">Total Keluar</div>
        <div id="totalKeluar" class="text-2xl font-bold mt-1">Rp 0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-slate-500">Profit (Masuk - Keluar)</div>
        <div id="profit" class="text-2xl font-bold mt-1">Rp 0</div>
      </div>
    </section>

    <!-- Form & Chart -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form -->
      <div class="card p-4 lg:col-span-1">
        <h2 class="text-lg font-semibold mb-3">Tambah Transaksi</h2>
        <form id="txForm" class="space-y-3">
          <div>
            <label class="label">Tanggal</label>
            <input id="tanggal" type="date" class="input" required />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Jenis</label>
              <select id="jenis" class="select" required>
                <option value="masuk">Masuk</option>
                <option value="keluar">Keluar</option>
              </select>
            </div>
            <div>
              <label class="label">Metode</label>
              <select id="metode" class="select">
                <option>Tunai</option>
                <option>Transfer</option>
                <option>EDC</option>
                <option>E-Wallet</option>
              </select>
            </div>
          </div>
          <div>
            <label class="label">Kategori</label>
            <select id="kategori" class="select">
              <option>Penjualan</option>
              <option>Tarik Tunai</option>
              <option>Setor Tunai</option>
              <option>Biaya EDC</option>
              <option>Pembelian</option>
              <option>Operasional</option>
              <option>Lainnya</option>
            </select>
          </div>
          <div>
            <label class="label">Deskripsi</label>
            <input id="deskripsi" type="text" class="input" placeholder="Contoh: Pulsa 50k / Tagihan PLN / Modal stok" />
          </div>
          <div>
            <label class="label">Nominal (Rp)</label>
            <input id="nominal" type="number" class="input" min="0" step="100" required />
          </div>
          <div class="flex items-center gap-2 text-xs text-slate-600">
            <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> untuk simpan cepat
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-primary" type="submit"><i class="ti ti-plus"></i> Tambah</button>
            <button id="resetFormBtn" class="btn" type="button"><i class="ti ti-refresh"></i> Reset</button>
          </div>
        </form>
      </div>

      <!-- Chart -->
      <div class="card p-4 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">Grafik Arus Kas Harian</h2>
          <div class="text-xs text-slate-500">(Netto per hari)</div>
        </div>
        <canvas id="cashflowChart" height="120"></canvas>
      </div>
    </section>

    <!-- Filters -->
    <section class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div>
          <label class="label">Dari</label>
          <input id="filterFrom" type="date" class="input" />
        </div>
        <div>
          <label class="label">Sampai</label>
          <input id="filterTo" type="date" class="input" />
        </div>
        <div>
          <label class="label">Kategori</label>
          <select id="filterKategori" class="select">
            <option value="">Semua</option>
            <option>Penjualan</option>
            <option>Tarik Tunai</option>
            <option>Setor Tunai</option>
            <option>Biaya EDC</option>
            <option>Pembelian</option>
            <option>Operasional</option>
            <option>Lainnya</option>
          </select>
        </div>
        <div>
          <label class="label">Metode</label>
          <select id="filterMetode" class="select">
            <option value="">Semua</option>
            <option>Tunai</option>
            <option>Transfer</option>
            <option>EDC</option>
            <option>E-Wallet</option>
          </select>
        </div>
        <div>
          <label class="label">Cari</label>
          <input id="filterSearch" type="text" class="input" placeholder="Deskripsi / nominal" />
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card p-2">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-700">
            <tr>
              <th class="text-left font-semibold p-3">Tanggal</th>
              <th class="text-left font-semibold p-3">Jenis</th>
              <th class="text-left font-semibold p-3">Kategori</th>
              <th class="text-left font-semibold p-3">Metode</th>
              <th class="text-left font-semibold p-3">Deskripsi</th>
              <th class="text-right font-semibold p-3">Nominal</th>
              <th class="text-right font-semibold p-3">Aksi</th>
            </tr>
          </thead>
          <tbody id="txTbody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between p-3 text-xs text-slate-600">
        <div id="itemCount">0 transaksi</div>
        <div>ðŸ“Œ Data disimpan di <b>localStorage</b> â€” aman selama tidak dihapus cache/riwayat browser.</div>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500 py-4">
      Dibuat untuk NJR Cell â€¢ Simpel, cepat, dan gratis. âœ¨
    </footer>
  </div>

  <script>
    // ===== Util =====
    const STORAGE_KEY = 'njr_cell_bukukas_v1';

    const fmtIDR = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });
    const el = (id) => document.getElementById(id);

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('Gagal baca storage', e); return [];
      }
    }
    function saveData(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function uid() { return Math.random().toString(36).slice(2, 10); }

    function sanitizeNumber(n) { return Number(n || 0); }

    function toCSV(rows) {
      const head = ['id','tanggal','jenis','kategori','metode','deskripsi','nominal'];
      const esc = (v) => '"' + String(v ?? '').replaceAll('"', '""') + '"';
      const body = rows.map(r => head.map(k => esc(r[k])).join(','));
      return head.join(',') + '\n' + body.join('\n');
    }

    function download(filename, content, type = 'text/plain') {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== State =====
    let data = loadData();
    let chart;

    // ===== Rendering =====
    function render() {
      // Filters
      const from = el('filterFrom').value ? new Date(el('filterFrom').value) : null;
      const to = el('filterTo').value ? new Date(el('filterTo').value) : null;
      const kat = el('filterKategori').value;
      const met = el('filterMetode').value;
      const q = el('filterSearch').value.trim().toLowerCase();

      let rows = [...data];
      rows.sort((a, b) => a.tanggal.localeCompare(b.tanggal));
      if (from) rows = rows.filter(r => new Date(r.tanggal) >= from);
      if (to) rows = rows.filter(r => new Date(r.tanggal) <= to);
      if (kat) rows = rows.filter(r => r.kategori === kat);
      if (met) rows = rows.filter(r => r.metode === met);
      if (q) rows = rows.filter(r => (r.deskripsi || '').toLowerCase().includes(q) || String(r.nominal).includes(q));

      // Table
      el('txTbody').innerHTML = rows.map(r => `
        <tr class="hover:bg-slate-50">
          <td class="p-3 whitespace-nowrap">${r.tanggal}</td>
          <td class="p-3">${r.jenis === 'masuk' ? '<span class="chip border-emerald-300 text-emerald-700 bg-emerald-50">Masuk</span>' : '<span class="chip border-rose-300 text-rose-700 bg-rose-50">Keluar</span>'}</td>
          <td class="p-3">${r.kategori}</td>
          <td class="p-3">${r.metode}</td>
          <td class="p-3">${r.deskripsi || '-'}</td>
          <td class="p-3 text-right font-medium ${r.jenis === 'masuk' ? 'text-emerald-700' : 'text-rose-700'}">${fmtIDR.format(r.nominal)}</td>
          <td class="p-3 text-right">
            <button class="btn" onclick="editTx('${r.id}')"><i class="ti ti-edit"></i> Edit</button>
            <button class="btn btn-danger" onclick="delTx('${r.id}')"><i class="ti ti-trash"></i> Hapus</button>
          </td>
        </tr>`).join('');

      el('itemCount').textContent = `${rows.length} transaksi`;

      // Stats
      const totalMasuk = rows.filter(r => r.jenis === 'masuk').reduce((s, r) => s + sanitizeNumber(r.nominal), 0);
      const totalKeluar = rows.filter(r => r.jenis === 'keluar').reduce((s, r) => s + sanitizeNumber(r.nominal), 0);
      const saldo = totalMasuk - totalKeluar;
      el('totalMasuk').textContent = fmtIDR.format(totalMasuk);
      el('totalKeluar').textContent = fmtIDR.format(totalKeluar);
      el('saldo').textContent = fmtIDR.format(saldo);
      el('profit').textContent = fmtIDR.format(saldo);

      // Chart data (net per day)
      const byDay = {};
      rows.forEach(r => {
        const d = r.tanggal;
        byDay[d] ??= 0;
        byDay[d] += (r.jenis === 'masuk' ? 1 : -1) * sanitizeNumber(r.nominal);
      });
      const labels = Object.keys(byDay).sort();
      const values = labels.map(k => byDay[k]);
      renderChart(labels, values);
    }

    function renderChart(labels, values) {
      const ctx = el('cashflowChart');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Netto Harian (Rp)', data: values }]
        },
        options: {
          responsive: true,
          scales: {
            y: { ticks: { callback: (v) => new Intl.NumberFormat('id-ID').format(v) } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // ===== CRUD =====
    function addTx(tx) {
      data.push(tx); saveData(data); render();
    }
    function updateTx(id, partial) {
      const i = data.findIndex(r => r.id === id);
      if (i !== -1) { data[i] = { ...data[i], ...partial }; saveData(data); render(); }
    }
    function delTx(id) {
      if (!confirm('Hapus transaksi ini?')) return;
      data = data.filter(r => r.id !== id); saveData(data); render();
    }
    function editTx(id) {
      const r = data.find(x => x.id === id);
      if (!r) return;
      el('tanggal').value = r.tanggal;
      el('jenis').value = r.jenis;
      el('kategori').value = r.kategori;
      el('metode').value = r.metode;
      el('deskripsi').value = r.deskripsi || '';
      el('nominal').value = r.nominal;
      el('txForm').dataset.editing = id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Expose for inline onclick
    window.editTx = editTx;
    window.delTx = delTx;

    // ===== Events =====
    el('txForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const tx = {
        id: el('txForm').dataset.editing || uid(),
        tanggal: el('tanggal').value || new Date().toISOString().slice(0,10),
        jenis: el('jenis').value,
        kategori: el('kategori').value,
        metode: el('metode').value,
        deskripsi: el('deskripsi').value.trim(),
        nominal: sanitizeNumber(el('nominal').value)
      };
      if (!tx.nominal) return alert('Nominal harus diisi.');

      if (el('txForm').dataset.editing) {
        updateTx(tx.id, tx);
        delete el('txForm').dataset.editing;
      } else {
        addTx(tx);
      }
      e.target.reset();
    });

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') { el('txForm').requestSubmit(); }
    });

    el('resetFormBtn').addEventListener('click', () => {
      el('txForm').reset();
      delete el('txForm').dataset.editing;
    });

    ['filterFrom','filterTo','filterKategori','filterMetode','filterSearch'].forEach(id => {
      el(id).addEventListener('input', render);
    });

    // Export/Import/Clear
    el('exportJsonBtn').addEventListener('click', () => {
      download(`njr-cell-bukukas-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(data, null, 2), 'application/json');
    });
    el('exportCsvBtn').addEventListener('click', () => {
      download(`njr-cell-bukukas-${new Date().toISOString().slice(0,10)}.csv`, toCSV(data), 'text/csv');
    });
    el('importJsonInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const text = await file.text();
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('Format tidak sesuai');
        // basic shape check
        data = arr.map(r => ({
          id: r.id || uid(),
          tanggal: r.tanggal || new Date().toISOString().slice(0,10),
          jenis: r.jenis === 'keluar' ? 'keluar' : 'masuk',
          kategori: r.kategori || 'Lainnya',
          metode: r.metode || 'Tunai',
          deskripsi: r.deskripsi || '',
          nominal: sanitizeNumber(r.nominal)
        }));
        saveData(data); render(); alert('Impor berhasil.');
      } catch (err) { alert('Gagal impor: ' + err.message); }
      e.target.value = '';
    });
    el('clearAllBtn').addEventListener('click', () => {
      if (confirm('Hapus semua data? Anda sebaiknya ekspor/backup dulu.')) {
        data = []; saveData(data); render();
      }
    });

    // Init
    (function init() {
      // Set default date to today
      el('tanggal').value = new Date().toISOString().slice(0,10);
      render();
    })();
  </script>
</body>
</html>
