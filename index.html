<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pembukuan NJR Cell</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <style>
    /* Styling untuk chart dan tabel */
    #chartContainer {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px 12px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h2>Pembukuan NJR Cell</h2>

  <!-- Form Input Transaksi -->
  <h3>Tambah Transaksi</h3>
  <input type="text" id="keterangan" placeholder="Keterangan">
  <input type="number" id="jumlah" placeholder="Jumlah" min="1">
  <select id="tipe">
    <option value="masuk">Uang Masuk</option>
    <option value="keluar">Uang Keluar</option>
  </select>
  <button onclick="simpanTransaksi()">Simpan</button>

  <!-- Grafik Transaksi -->
  <div id="chartContainer">
    <canvas id="transactionChart"></canvas>
  </div>

  <h3>Laporan Keuangan</h3>
  <p>Total Masuk: <b id="totalMasuk">Rp 0</b></p>
  <p>Total Keluar: <b id="totalKeluar">Rp 0</b></p>
  <p>Saldo Akhir: <b id="saldo">Rp 0</b></p>

  <h3>Daftar Transaksi</h3>
  <table id="tabelTransaksi">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Keterangan</th>
        <th>Jumlah</th>
        <th>Tipe</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Inisialisasi Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let transaksiData = [];

    // Menyimpan transaksi
    function simpanTransaksi() {
      const keterangan = document.getElementById("keterangan").value;
      const jumlah = parseInt(document.getElementById("jumlah").value);
      const tipe = document.getElementById("tipe").value;

      if (keterangan && jumlah) {
        const newRef = db.ref("transaksi").push();
        newRef.set({
          keterangan: keterangan,
          jumlah: jumlah,
          tipe: tipe,
          tanggal: new Date().toLocaleString()
        });

        // Clear input fields after saving
        document.getElementById("keterangan").value = "";
        document.getElementById("jumlah").value = "";
        loadTransaksi();  // Reload transaksi setelah simpan
      }
    }

    // Menampilkan transaksi di tabel dan mengupdate grafik
    function loadTransaksi() {
      const tbody = document.querySelector("#tabelTransaksi tbody");
      db.ref("transaksi").on("value", snapshot => {
        tbody.innerHTML = "";  // Clear the table body before loading new data
        transaksiData = [];  // Clear previous data for chart

        let totalMasuk = 0;
        let totalKeluar = 0;

        snapshot.forEach(child => {
          const data = child.val();
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${data.tanggal}</td>
            <td>${data.keterangan}</td>
            <td>Rp ${data.jumlah.toLocaleString()}</td>
            <td>${data.tipe}</td>
            <td>
              <button onclick="editTransaksi('${child.key}', '${data.keterangan}', ${data.jumlah}, '${data.tipe}')">✏️</button>
              <button onclick="hapusTransaksi('${child.key}')">❌</button>
            </td>
          `;

          tbody.appendChild(row);

          // Menghitung total
          if (data.tipe === "masuk") {
            totalMasuk += data.jumlah;
          } else {
            totalKeluar += data.jumlah;
          }

          // Menyimpan data untuk grafik
          const transactionDate = new Date(data.tanggal).toLocaleDateString();
          transaksiData.push({ date: transactionDate, amount: data.jumlah, type: data.tipe });
        });

        // Update saldo
        document.getElementById("totalMasuk").innerText = "Rp " + totalMasuk.toLocaleString();
        document.getElementById("totalKeluar").innerText = "Rp " + totalKeluar.toLocaleString();
        document.getElementById("saldo").innerText = "Rp " + (totalMasuk - totalKeluar).toLocaleString();

        updateChart();
      });
    }

    // Menghapus transaksi
    function hapusTransaksi(id) {
      if (confirm("Yakin mau hapus transaksi ini?")) {
        db.ref("transaksi/" + id).remove();
      }
    }

    // Mengedit transaksi
    function editTransaksi(id, keterangan, jumlah, tipe) {
      document.getElementById("keterangan").value = keterangan;
      document.getElementById("jumlah").value = jumlah;
      document.getElementById("tipe").value = tipe;
      document.getElementById("simpanTransaksi").onclick = function() {
        db.ref("transaksi/" + id).update({
          keterangan: document.getElementById("keterangan").value,
          jumlah: parseInt(document.getElementById("jumlah").value),
          tipe: document.getElementById("tipe").value,
          tanggal: new Date().toLocaleString()
        });
      };
    }

    // Update grafik
    function updateChart() {
      const dates = [];
      const masukData = [];
      const keluarData = [];

      // Organize data for chart
      transaksiData.forEach(item => {
        if (!dates.includes(item.date)) {
          dates.push(item.date);
          masukData.push(0);
          keluarData.push(0);
        }
        const index = dates.indexOf(item.date);
        if (item.type === "masuk") {
          masukData[index] += item.amount;
        } else {
          keluarData[index] += item.amount;
        }
      });

      // Setup the chart
      const ctx = document.getElementById("transactionChart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: dates,
          datasets: [{
            label: 'Uang Masuk',
            data: masukData,
            backgroundColor: 'rgba(0, 255, 0, 0.5)',
          }, {
            label: 'Uang Keluar',
            data: keluarData,
            backgroundColor: 'rgba(255, 0, 0, 0.5)',
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Load transaksi saat pertama kali
    loadTransaksi();
  </script>
</body>
</html>
